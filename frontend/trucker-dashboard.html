<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TruckNest - Trucker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Navbar -->
  <nav class="bg-[#1F3A93] shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <span class="text-2xl font-bold text-white">TruckNest</span>
        <span class="text-white text-sm hidden md:inline" id="userEmail">(user@email.com)</span>
      </div>
      <div class="flex items-center gap-4">
        <button id="notificationBtn" class="relative text-white focus:outline-none">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
          <span class="absolute top-0 right-0 inline-block w-2 h-2 bg-red-500 rounded-full"></span>
        </button>
        <a href="index.html" class="text-white hover:text-[#FFA500] font-medium">Logout</a>
      </div>
    </div>
  </nav>
  <div class="flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar -->
    <aside class="bg-white shadow-md w-full md:w-56 p-4 flex flex-row md:flex-col gap-2 md:gap-4 md:min-h-screen">
      <a href="#" class="block py-2 px-4 rounded hover:bg-[#FFA500] hover:text-white transition">Dashboard</a>
      <a href="#" id="openProfileModal" class="block py-2 px-4 rounded hover:bg-[#FFA500] hover:text-white transition">Profile</a>
      <a href="#vehicles" class="block py-2 px-4 rounded hover:bg-[#FFA500] hover:text-white transition">My Vehicles</a>
      <a href="#bookings" class="block py-2 px-4 rounded hover:bg-[#FFA500] hover:text-white transition">Bookings</a>
      <a href="#favorites" class="block py-2 px-4 rounded hover:bg-[#FFA500] hover:text-white transition">Favorites</a>
      <a href="#support" class="block py-2 px-4 rounded hover:bg-[#FFA500] hover:text-white transition">Support</a>
      <a href="#" id="openMessagesModal" class="block py-2 px-4 rounded hover:bg-[#FFA500] hover:text-white transition flex items-center">Messages <span id="unreadBadge" class="ml-2 hidden bg-red-500 text-white text-xs rounded-full px-2 py-0.5"></span></a>
    </aside>
    <!-- Main Content -->
    <main class="flex-1 px-4 py-8">
      <!-- Onboarding Modal -->
      <div id="onboardingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-8 relative">
          <button id="closeOnboardingModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
          <h2 class="text-2xl font-bold mb-4 text-[#1F3A93]">Welcome to TruckNest!</h2>
          <ul class="mb-4 space-y-2">
            <li><input type="checkbox" checked disabled class="mr-2">Complete Your Profile</li>
            <li><input type="checkbox" disabled class="mr-2">Search for Parking</li>
            <li><input type="checkbox" disabled class="mr-2">Book Your First Spot</li>
          </ul>
          <button id="closeOnboardingBtn" class="w-full bg-[#FFA500] text-white px-4 py-2 rounded-full font-semibold hover:bg-orange-600 transition">Get Started</button>
        </div>
      </div>
      <!-- Dashboard Content -->
      <div id="dashboardContent">
        <h1 class="text-2xl font-bold mb-4 text-[#1F3A93]">Dashboard</h1>
        <section class="mb-8">
          <h2 class="text-xl font-semibold mb-2">Recent & Recommended Parking</h2>
          <div class="bg-gray-100 rounded p-4 text-gray-500">(Feature coming soon)</div>
        </section>
        <section id="bookings" class="mb-8">
          <h2 class="text-xl font-semibold mb-2">Upcoming & Past Bookings</h2>
          <div class="bg-gray-100 rounded p-4 text-gray-500">(Feature coming soon)</div>
        </section>
        <section id="vehicles" class="mb-8">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">My Vehicles</h2>
            <button id="addVehicleBtn" class="bg-[#FFA500] text-white px-4 py-2 rounded-full font-semibold hover:bg-orange-600 transition">Add Vehicle</button>
          </div>
          <div id="vehiclesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Vehicle cards will be populated here -->
          </div>
        </section>
        <section id="favorites" class="mb-8">
          <h2 class="text-xl font-semibold mb-2">Favorite Locations</h2>
          <div class="bg-gray-100 rounded p-4 text-gray-500">(Feature coming soon)</div>
        </section>
      </div>

      <!-- Support Section -->
      <div id="supportContent" class="hidden">
        <div id="supportTicketRoot"></div>
      </div>
    </main>
    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-8 relative">
        <button id="closeProfileModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-2xl font-bold mb-4 text-[#1F3A93]">Profile & Settings</h2>
        <form class="space-y-4">
          <input type="text" placeholder="Name" class="w-full px-4 py-2 rounded border border-gray-300">
          <input type="email" placeholder="Email" class="w-full px-4 py-2 rounded border border-gray-300">
          <input type="password" placeholder="Change Password" class="w-full px-4 py-2 rounded border border-gray-300">
          <button type="submit" class="bg-[#FFA500] text-white px-6 py-2 rounded-full font-semibold hover:bg-orange-600 transition">Save Changes</button>
        </form>
      </div>
    </div>
    <!-- Messaging Modal -->
    <div id="messagesModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6 relative flex flex-col h-[80vh]">
        <button id="closeMessagesModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-2xl font-bold mb-4 text-[#1F3A93]">Messages</h2>
        <div class="flex flex-1 gap-4 overflow-hidden">
          <!-- Conversation List -->
          <div class="w-1/3 border-r overflow-y-auto">
            <ul id="conversationList" class="space-y-2"></ul>
          </div>
          <!-- Chat Window -->
          <div class="flex-1 flex flex-col">
            <div id="chatHeader" class="font-semibold text-[#1F3A93] mb-2"></div>
            <div id="chatMessages" class="flex-1 overflow-y-auto bg-gray-50 rounded p-2 mb-2"></div>
            <form id="sendMessageForm" class="flex gap-2 mt-auto">
              <input type="text" id="messageInput" class="flex-1 px-3 py-2 rounded border border-gray-300" placeholder="Type a message..." autocomplete="off">
              <button type="submit" class="bg-[#FFA500] text-white px-4 py-2 rounded-full font-semibold hover:bg-orange-600 transition">Send</button>
            </form>
          </div>
        </div>
        <div id="messageNotification" class="hidden mt-2 p-2 rounded text-white font-semibold"></div>
      </div>
    </div>
    <!-- Review Modal -->
    <div id="reviewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-8 relative">
        <button id="closeReviewModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-2xl font-bold mb-4 text-[#1F3A93]">Leave a Review</h2>
        <form id="reviewForm" class="space-y-4">
          <div>
            <label class="block text-gray-700 font-semibold mb-1">Rate the Parking Spot</label>
            <div id="starRating" class="flex gap-1 text-2xl cursor-pointer">
              <span data-value="1">☆</span><span data-value="2">☆</span><span data-value="3">☆</span><span data-value="4">☆</span><span data-value="5">☆</span>
            </div>
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-1">Your Review</label>
            <textarea id="reviewText" class="w-full px-4 py-2 rounded border border-gray-300" rows="3" required></textarea>
          </div>
          <button type="submit" class="w-full bg-[#FFA500] text-white px-4 py-2 rounded-full font-semibold hover:bg-orange-600 transition">Submit Review</button>
        </form>
      </div>
    </div>
    <!-- Vehicle Modal -->
    <div id="vehicleModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-8 relative">
        <button id="closeVehicleModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-2xl font-bold mb-4 text-[#1F3A93]">Add Vehicle</h2>
        <form id="vehicleForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Vehicle Type</label>
            <select name="type" class="w-full px-4 py-2 rounded border border-gray-300" required>
              <option value="">Select Type</option>
              <option value="Truck and Trailer">Truck and Trailer</option>
              <option value="Bobtail Truck">Bobtail Truck</option>
              <option value="Heavy Equipment">Heavy Equipment</option>
              <option value="Boat">Boat</option>
              <option value="RV">RV</option>
              <option value="Container">Container</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Make</label>
            <input type="text" name="make" class="w-full px-4 py-2 rounded border border-gray-300" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
            <input type="text" name="model" class="w-full px-4 py-2 rounded border border-gray-300" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
            <input type="number" name="year" min="1900" max="2025" class="w-full px-4 py-2 rounded border border-gray-300" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">License Plate</label>
            <input type="text" name="licensePlate" class="w-full px-4 py-2 rounded border border-gray-300" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Length (ft)</label>
            <input type="number" name="length" min="0" step="0.1" class="w-full px-4 py-2 rounded border border-gray-300" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Weight (lbs)</label>
            <input type="number" name="weight" min="0" step="100" class="w-full px-4 py-2 rounded border border-gray-300" required>
          </div>
          <div>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="hazmat">
              <span class="text-sm font-medium text-gray-700">Hazardous Materials</span>
            </label>
          </div>
          <div>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="powerNeeded">
              <span class="text-sm font-medium text-gray-700">Requires Power Hookup</span>
            </label>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
            <textarea name="notes" class="w-full px-4 py-2 rounded border border-gray-300 h-24"></textarea>
          </div>
          <button type="submit" class="w-full bg-[#FFA500] text-white px-4 py-2 rounded-full font-semibold hover:bg-orange-600 transition">Save Vehicle</button>
        </form>
      </div>
    </div>
  </div>
  <script type="module">
    import { auth, db } from './firebase.js';
    import { doc, getDoc, collection, query, where, getDocs, updateDoc, addDoc, orderBy, onSnapshot, serverTimestamp, setDoc } from 'firebase/firestore';
    import { onAuthStateChanged } from 'firebase/auth';
    import SupportTicket from './components/SupportTicket.js';

    const userEmailSpan = document.getElementById('userEmail');
    const profileModal = document.getElementById('profileModal');
    const onboardingModal = document.getElementById('onboardingModal');
    const onboardingSteps = [
      { key: 'profileComplete', label: 'Complete Your Profile' },
      { key: 'firstBookingMade', label: 'Book Your First Spot' }
    ];

    let currentUser = null;
    let userDocRef = null;
    let currentThreadId = null;
    let unsubscribeMessages = null;
    let reviewTarget = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = user;
      if (userEmailSpan) userEmailSpan.textContent = user.email;
      // Fetch user profile from Firestore
      const q = query(collection(db, 'users'), where('uid', '==', user.uid));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const userDoc = snap.docs[0];
        userDocRef = userDoc.ref;
        const data = userDoc.data();
        // Fill profile modal
        if (profileModal) {
          const inputs = profileModal.querySelectorAll('input');
          inputs.forEach(input => {
            if (input.type === 'email') input.value = data.email || '';
            if (input.type === 'text' && input.placeholder === 'Name') input.value = data.name || '';
          });
        }
        // Onboarding progress
        let allComplete = true;
        onboardingSteps.forEach(step => {
          if (!data[step.key]) allComplete = false;
          const li = Array.from(onboardingModal.querySelectorAll('li')).find(l => l.textContent.includes(step.label));
          if (li) {
            li.querySelector('input[type="checkbox"]').checked = !!data[step.key];
          }
        });
        if (allComplete && onboardingModal) onboardingModal.classList.add('hidden');
        else if (onboardingModal) onboardingModal.classList.remove('hidden');
      }
      // Fetch bookings
      const bookingsSection = document.getElementById('bookings');
      if (bookingsSection) {
        const bookingsQ = query(collection(db, 'bookings'), where('userId', '==', user.uid));
        const bookingsSnap = await getDocs(bookingsQ);
        const bookings = [];
        bookingsSnap.forEach(doc => bookings.push(doc.data()));
        const bookingsDiv = bookingsSection.querySelector('div');
        if (bookings.length > 0) {
          const today = new Date();
          bookingsDiv.innerHTML = bookings.map(b => {
            let showReview = false;
            if (b.status === 'approved') {
              if (b.endDate) {
                // If endDate is in the past
                const end = new Date(b.endDate);
                if (end < today) showReview = true;
                // If monthly, allow review after 2 weeks
                if (b.duration === 'monthly') {
                  const start = new Date(b.startDate);
                  const twoWeeks = new Date(start);
                  twoWeeks.setDate(start.getDate() + 14);
                  if (today > twoWeeks) showReview = true;
                }
              }
            }
            return `<div class='mb-2 p-2 bg-white rounded shadow'><b>${b.status}</b> - ${b.createdAt?.toDate?.().toLocaleString?.() || ''}<br><button class='message-btn bg-blue-500 text-white px-3 py-1 rounded' onclick='openMessageWithUser("${b.ownerId}", "${b.ownerEmail || b.ownerId}")'>Message</button>${showReview ? `<button class='review-btn bg-yellow-500 text-white px-3 py-1 rounded ml-2' onclick='openReviewModal({listingId: "${b.parkingId}", landownerId: "${b.ownerId}"})'>Review</button>` : ''}</div>`;
          }).join('');
        }
      }
      // Fetch all threads for this user
      const threadsQ = query(collection(db, 'messages'), where('participants', 'array-contains', user.uid));
      onSnapshot(threadsQ, async (threadsSnap) => {
        let threads = [];
        let unreadCount = 0;
        threadsSnap.forEach(docSnap => {
          const data = docSnap.data();
          threads.push({ ...data, id: docSnap.id });
          if (data.lastMessage && data.lastMessage.senderId !== user.uid && (!data.lastMessage.readBy || !data.lastMessage.readBy.includes(user.uid))) unreadCount++;
        });
        // Update unread badge
        if (unreadCount > 0) {
          const unreadBadge = document.getElementById('unreadBadge');
          unreadBadge.textContent = unreadCount;
          unreadBadge.classList.remove('hidden');
        } else {
          unreadBadge.classList.add('hidden');
        }
        // Render conversation list
        const conversationList = document.getElementById('conversationList');
        conversationList.innerHTML = threads.map(t => `
          <li class="p-2 rounded cursor-pointer hover:bg-gray-100 flex justify-between items-center ${t.id === currentThreadId ? 'bg-gray-200' : ''}" data-id="${t.id}">
            <span>${t.participantNames?.filter(n => n !== user.email).join(', ') || 'Conversation'}</span>
            ${t.lastMessage && t.lastMessage.senderId !== user.uid && (!t.lastMessage.readBy || !t.lastMessage.readBy.includes(user.uid)) ? '<span class="bg-red-500 text-white text-xs rounded-full px-2">New</span>' : ''}
          </li>
        `).join('');
        // Add click listeners
        conversationList.querySelectorAll('li').forEach(li => {
          li.addEventListener('click', () => openThread(li.dataset.id));
        });
        // Auto-open first thread
        if (!currentThreadId && threads.length > 0) openThread(threads[0].id);
      });
    });
    // Profile modal save
    if (profileModal) {
      profileModal.querySelector('form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!userDocRef) return;
        const name = this.querySelector('input[placeholder="Name"]').value;
        const email = this.querySelector('input[placeholder="Email"]').value;
        await updateDoc(userDocRef, { name, email, profileComplete: true });
        alert('Profile updated!');
        profileModal.classList.add('hidden');
      });
    }
    // Messaging UI Elements
    const openMessagesModal = document.getElementById('openMessagesModal');
    const closeMessagesModal = document.getElementById('closeMessagesModal');
    const messagesModal = document.getElementById('messagesModal');
    const conversationList = document.getElementById('conversationList');
    const chatHeader = document.getElementById('chatHeader');
    const chatMessages = document.getElementById('chatMessages');
    const sendMessageForm = document.getElementById('sendMessageForm');
    const messageInput = document.getElementById('messageInput');
    const messageNotification = document.getElementById('messageNotification');

    function showMessageNotification(message, type) {
      messageNotification.textContent = message;
      messageNotification.className = `mt-2 p-2 rounded text-white font-semibold ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      messageNotification.classList.remove('hidden');
      setTimeout(() => messageNotification.classList.add('hidden'), 3000);
    }

    function openModal() { messagesModal.classList.remove('hidden'); }
    function closeModal() { messagesModal.classList.add('hidden'); if (unsubscribeMessages) unsubscribeMessages(); }
    if (openMessagesModal && closeMessagesModal && messagesModal) {
      openMessagesModal.addEventListener('click', e => { e.preventDefault(); openModal(); });
      closeMessagesModal.addEventListener('click', closeModal);
      window.addEventListener('click', e => { if (e.target === messagesModal) closeModal(); });
    }

    async function openThread(threadId) {
      currentThreadId = threadId;
      // Fetch thread info
      const threadRef = doc(db, 'messages', threadId);
      const threadSnap = await getDoc(threadRef);
      const threadData = threadSnap.data();
      chatHeader.textContent = threadData.participantNames?.filter(n => n !== currentUser.email).join(', ') || 'Conversation';
      // Listen for messages
      if (unsubscribeMessages) unsubscribeMessages();
      const messagesQ = query(collection(db, 'messages', threadId, 'messages'), orderBy('timestamp'));
      unsubscribeMessages = onSnapshot(messagesQ, snap => {
        chatMessages.innerHTML = '';
        snap.forEach(msgDoc => {
          const msg = msgDoc.data();
          const isMe = msg.senderId === currentUser.uid;
          const msgDiv = document.createElement('div');
          msgDiv.className = `mb-2 p-2 rounded ${isMe ? 'bg-[#FFA500] text-white ml-auto' : 'bg-gray-200 text-gray-800 mr-auto'}`;
          msgDiv.style.maxWidth = '70%';
          msgDiv.textContent = msg.text;
          chatMessages.appendChild(msgDiv);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
      // Mark last message as read
      if (threadData.lastMessage && threadData.lastMessage.senderId !== currentUser.uid && (!threadData.lastMessage.readBy || !threadData.lastMessage.readBy.includes(currentUser.uid))) {
        await updateDoc(threadRef, { 'lastMessage.readBy': [...(threadData.lastMessage.readBy || []), currentUser.uid] });
      }
    }

    if (sendMessageForm) {
      sendMessageForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!currentThreadId || !messageInput.value.trim()) return;
        const threadRef = doc(db, 'messages', currentThreadId);
        const msg = {
          senderId: currentUser.uid,
          text: messageInput.value,
          timestamp: serverTimestamp(),
          readBy: [currentUser.uid]
        };
        await addDoc(collection(db, 'messages', currentThreadId, 'messages'), msg);
        await updateDoc(threadRef, {
          lastMessage: { ...msg, timestamp: serverTimestamp() },
        });
        messageInput.value = '';
        showMessageNotification('Message sent!', 'success');
      });
    }

    // Add openMessageWithUser to window for global access
    window.openMessageWithUser = async function(userId, userEmail) {
      // Check if thread exists
      const threadsQ = query(collection(db, 'messages'), where('participants', 'array-contains', currentUser.uid));
      const threadsSnap = await getDocs(threadsQ);
      let foundThread = null;
      threadsSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data.participants.includes(userId)) foundThread = docSnap.id;
      });
      if (foundThread) {
        openModal();
        openThread(foundThread);
      } else {
        // Create new thread
        const threadRef = doc(collection(db, 'messages'));
        await setDoc(threadRef, {
          participants: [currentUser.uid, userId],
          participantNames: [currentUser.email, userEmail],
          lastMessage: null,
          lastTimestamp: serverTimestamp()
        });
        openModal();
        openThread(threadRef.id);
      }
    }

    const reviewModal = document.getElementById('reviewModal');
    const closeReviewModal = document.getElementById('closeReviewModal');
    const reviewForm = document.getElementById('reviewForm');
    const starRating = document.getElementById('starRating');
    const reviewText = document.getElementById('reviewText');
    let selectedRating = 0;

    function openReviewModal(target) {
      reviewTarget = target; // {listingId, landownerId}
      reviewModal.classList.remove('hidden');
      selectedRating = 0;
      Array.from(starRating.children).forEach(star => star.textContent = '☆');
      reviewText.value = '';
    }
    if (closeReviewModal) closeReviewModal.addEventListener('click', () => reviewModal.classList.add('hidden'));
    if (starRating) {
      Array.from(starRating.children).forEach(star => {
        star.addEventListener('mouseenter', function() {
          const val = Number(this.dataset.value);
          Array.from(starRating.children).forEach((s, i) => s.textContent = i < val ? '★' : '☆');
        });
        star.addEventListener('mouseleave', function() {
          Array.from(starRating.children).forEach((s, i) => s.textContent = i < selectedRating ? '★' : '☆');
        });
        star.addEventListener('click', function() {
          selectedRating = Number(this.dataset.value);
          Array.from(starRating.children).forEach((s, i) => s.textContent = i < selectedRating ? '★' : '☆');
        });
      });
    }
    if (reviewForm) {
      reviewForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!selectedRating || !reviewTarget) return;
        // Save review for listing
        await addDoc(collection(db, 'reviews'), {
          reviewerId: currentUser.uid,
          reviewerType: 'trucker',
          targetId: reviewTarget.listingId,
          targetType: 'listing',
          rating: selectedRating,
          text: reviewText.value,
          createdAt: new Date()
        });
        // Optionally, save review for landowner
        await addDoc(collection(db, 'reviews'), {
          reviewerId: currentUser.uid,
          reviewerType: 'trucker',
          targetId: reviewTarget.landownerId,
          targetType: 'landowner',
          rating: selectedRating,
          text: reviewText.value,
          createdAt: new Date()
        });
        reviewModal.classList.add('hidden');
        alert('Thank you for your review!');
      });
    }

    // Show review modal after booking completion (example: add a button to bookings)
    // ...existing code...
    if (bookings.length > 0) {
      const today = new Date();
      bookingsDiv.innerHTML = bookings.map(b => {
        let showReview = false;
        if (b.status === 'approved') {
          if (b.endDate) {
            // If endDate is in the past
            const end = new Date(b.endDate);
            if (end < today) showReview = true;
            // If monthly, allow review after 2 weeks
            if (b.duration === 'monthly') {
              const start = new Date(b.startDate);
              const twoWeeks = new Date(start);
              twoWeeks.setDate(start.getDate() + 14);
              if (today > twoWeeks) showReview = true;
            }
          }
        }
        return `<div class='mb-2 p-2 bg-white rounded shadow'><b>${b.status}</b> - ${b.createdAt?.toDate?.().toLocaleString?.() || ''}<br><button class='message-btn bg-blue-500 text-white px-3 py-1 rounded' onclick='openMessageWithUser("${b.ownerId}", "${b.ownerEmail || b.ownerId}")'>Message</button>${showReview ? `<button class='review-btn bg-yellow-500 text-white px-3 py-1 rounded ml-2' onclick='openReviewModal({listingId: "${b.parkingId}", landownerId: "${b.ownerId}"})'>Review</button>` : ''}</div>`;
      }).join('');
    }
    window.openReviewModal = openReviewModal;
    // Display average ratings and recent reviews for listings (example: in dashboard or listing cards)
    // ...fetch and display logic can be added as needed...

    // Support section handling
    const supportLink = document.querySelector('a[href="#support"]');
    const dashboardContent = document.getElementById('dashboardContent');
    const supportContent = document.getElementById('supportContent');
    const supportTicketRoot = document.getElementById('supportTicketRoot');

    if (supportLink) {
      supportLink.addEventListener('click', (e) => {
        e.preventDefault();
        dashboardContent.classList.add('hidden');
        supportContent.classList.remove('hidden');
        
        // Initialize Support Ticket component
        const supportTicket = new SupportTicket();
        supportTicketRoot.innerHTML = ''; // Clear existing content
        supportTicketRoot.appendChild(supportTicket);
      });
    }

    // Add click handler for dashboard link to show main content
    const dashboardLink = document.querySelector('a[href="#"]');
    if (dashboardLink) {
      dashboardLink.addEventListener('click', (e) => {
        e.preventDefault();
        supportContent.classList.add('hidden');
        dashboardContent.classList.remove('hidden');
      });
    }
  </script>
  <script type="module" src="js/vehicle-manager.js"></script>
</body>
</html> 